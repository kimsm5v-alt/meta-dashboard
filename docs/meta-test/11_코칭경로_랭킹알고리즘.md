# 개인별 코칭 경로 랭킹 알고리즘

## 1. 개요

### 1.1 목적
같은 LPA 유형이라도 학생마다 38개 T점수 프로필이 다르므로, 유형별 코칭 경로를 개인의 취약 요인에 따라 관련도 순으로 정렬하여 맞춤형 코칭을 지원한다.

### 1.2 위치
- 알고리즘: `src/shared/utils/interventionRanker.ts`
- 코칭 경로 데이터: `src/shared/data/lpaProfiles.ts` → `TypeProfile.interventions`
- 지식그래프: `src/shared/data/knowledgeGraph.ts`
- UI: `src/features/student-dashboard/components/CoachingStrategy.tsx`

---

## 2. 코칭 경로 데이터 구조

### 2.1 Intervention 인터페이스

```typescript
interface Intervention {
  x: string;           // 독립변수 (예: '자기효능감')
  z: string | null;    // 매개/조절변수 (예: '자아존중감', 없으면 null)
  y: string;           // 결과변수 (예: '학업성취도')
  effectType: EffectType;  // 효과 유형
  interpretation: string;  // 경로 해석
  strategies: string[];    // 구체적 실행 전략 (3개)
  beta?: number;           // 효과크기 (|β|, 양수) — KG 통계 검증 경로만
  source?: 'KG' | 'KG_INTERVENTION' | 'INFERRED';  // 데이터 출처
}
```

### 2.2 데이터 출처 (source)

| source | 의미 | β 유무 | UI 배지 | 설명 |
|--------|------|:---:|------|------|
| `KG` | 매개경로 또는 조절효과 (통계적 검증) | O | `β=0.XXX` (indigo) | 지식그래프의 매개경로 또는 조절효과에서 도출. 통계적으로 검증된 효과크기(β)가 있어 신뢰도가 가장 높음 |
| `KG_INTERVENTION` | 지식그래프 개입전략 노드 | X | `β 없음` (amber) | 지식그래프에 개입전략 노드가 존재하나, 매개/조절 분석이 수행되지 않아 β 계수가 없음. 경로의 방향성은 KG에 근거하지만 효과크기는 미검증 |
| `INFERRED` | AI 추론 (KG 근거 없음) | X | `AI 추론` (purple) | 지식그래프에 직접적 근거가 없으며, 유형 특성과 요인 프로필을 바탕으로 AI가 생성한 경로. 추후 통계 검증 필요 |

### 2.3 효과 유형 (EffectType)

| 유형 | 의미 | 예시 |
|------|------|------|
| 직접효과 | X가 Y에 직접 영향 (z=null) | 시험준비 → 학업성취도 |
| 완전매개 | X → Z → Y 매개 경로 | 자기효능감 → 자아존중감 → 성적만족도 |
| 긍정강화 | X × Z 결합 시 시너지 | 타인정서인식 × 활기 → 성적만족도 |
| 긍정완충 | X × Z 동시 강화 시 효과 감소 | 효능감 × 자존감 동시 상승 → 심리 부하 |
| 촉진 | Z 수준에 따라 X 효과 증폭 | 시간관리 × 공부부담 → 성적만족도 |

### 2.4 유형별 경로 수 및 검증 상태

| 학교급 | 유형 | 경로 수 | KG | KG_INTERVENTION | INFERRED | 상세 |
|--------|------|:---:|:---:|:---:|:---:|------|
| 초등 | 자원소진형 | 8 | 7 | 1 | 0 | 기존 3 + 교사정서지지 조절효과 5개 추가 |
| 초등 | 안전균형형 | 18 | 18 | 0 | 0 | 기존 3 + 매개경로 9개(성장마인드셋·조절능력·의미감 경유) + 조절효과 6개(교사정서지지 5 + 계획능력 1) |
| 초등 | 몰입자원풍부형 | 3 | 1 | 1 | 1 | 변경 없음 |
| 중등 | 무기력형 | 13 | 13 | 0 | 0 | 기존 4 + 매개경로 4개(부모학업지지·자기효능감·조절능력 경유) + 조절효과 5개(교사정서지지 4 + 공부부담 1) |
| 중등 | 정서조절취약형 | 12 | 11 | 0 | 1 | 기존 4 + 매개경로 8개(성장마인드셋 경유, 학업성취도·성적만족도 각 4) |
| 중등 | 자기주도몰입형 | 3 | 2 | 1 | 0 | 변경 없음 |
| | **합계** | **57** | **52** | **3** | **2** | |

**β 커버리지: 52/57 (91.2%)**

경로 데이터는 로컬 지식그래프 + HuggingFace KG 데이터에서 파생되었다. v2 업데이트에서 HF KG 전면 통합으로 매개경로 8개 모델, 조절효과 16개가 추가되었다.

### 2.5 부정적 간접효과 경로 (Negative β)

일부 매개경로는 간접효과(β)가 음수이다. 이는 X가 Z를 경유하여 Y를 **저하**시키는 경로이므로, 해석 문구에 `⚠` 표시를 붙여 주의를 환기한다.

| 학교급 | 유형 | 경로 | 간접효과 β | 해석 |
|--------|------|------|:---:|------|
| 초등 | 안전균형형 | 자기정서인식 → 의미감 → 성적만족도 | **-0.033** | 과도한 자기 인식이 부담으로 전환, 성적만족도 미세 저하 |
| 중등 | 무기력형 | 부모공부부담 → 부모학업지지 → 성적만족도 | **-0.077** | 부모 부담 인식이 지지 수용을 방해하여 만족도 저하 |
| 중등 | 무기력형 | 부모공부부담 → 자기효능감 → 성적만족도 | **-0.047** | 부모 부담이 효능감을 저해하여 만족도 하락 |

**UI 표시**: `intervention.beta`에는 절대값(|β|)이 저장되며, `interpretation` 문구에 `⚠ 주의:` 접두어와 원래 음수 부호(β=-0.033 등)를 포함하여 부정적 방향성을 명시한다.

**랭킹 영향**: `betaBoost`는 `|β| × 200`으로 계산하므로 부정적 경로도 효과크기에 따라 상위에 노출될 수 있다. 이는 의도된 동작으로, 부정적 경로일수록 교사가 주의해야 할 개입 지점이기 때문이다.

### 2.6 HF KG 전면 통합 (v2 데이터 확장)

v2에서 HuggingFace 지식그래프 데이터를 전면 통합하여 경로가 20 → 57개로 확장되었다.

#### 추가된 매개경로 모델 (MEDIATION_PATHS, +8개)

매개경로는 Z(매개변수)→Y(결과변수) 기준으로 그룹화되어 추가되었다.

| # | Z(매개) → Y(결과) | X 변수 (신규) | 적용 유형 | β |
|---|------|------|------|:---:|
| 1 | 성장마인드셋 → 성적만족도 | 자기효능감, 자아존중감, 공부부담, 유능성 | 초등 안전균형형 | 0.122 |
| 2 | 조절능력 → 학업성취도 | 친구공부비교 | 초등 안전균형형 | 0.117 |
| 3 | 의미감 → 성적만족도 | 자기정서인식 | 초등 안전균형형 | **-0.033** ⚠ |
| 4 | 부모학업지지 → 성적만족도 | 부모공부부담 | 중등 무기력형 | **-0.077** ⚠ |
| 5 | 자기효능감 → 성적만족도 | 부모공부부담 | 중등 무기력형 | **-0.047** ⚠ |
| 6 | 조절능력 → 학업성취도 | 점검능력, 친구공부비교 | 중등 무기력형 | 0.117 |
| 7 | 성장마인드셋 → 학업성취도 | 자기효능감, 자아존중감, 공부부담, 유능성 | 중등 정서조절취약형 | 0.045 |
| 8 | 성장마인드셋 → 성적만족도 | 자기효능감, 자아존중감, 공부부담, 유능성 | 중등 정서조절취약형 | 0.122 |

**신규 매개변수 노드**: 자기효능감 (기존에는 X 변수로만 사용, 이제 Z로도 활용)

**신규 X 변수**: 부모의사소통, 친구공부비교, 부모공부부담

#### 추가된 조절효과 (MODERATION_EFFECTS, +16개)

교차 유형 교사정서지지 조절효과가 핵심이다. 교사의 정서적 지지가 다양한 학습 요인의 부정적 영향을 완충하는 패턴이 4개 유형에 걸쳐 확인되었다.

| 적용 유형 | 조절효과 수 | 주요 패턴 |
|-----------|:---:|------|
| 초등 자원소진형 | +5 | 수업부담·부모의사소통·조절능력·점검능력·계획능력 × 교사정서지지 |
| 초등 안전균형형 | +6 | 위와 동일 5개 + 시간관리×계획능력→성적만족도 |
| 중등 무기력형 | +5 | 부모의사소통·조절능력·점검능력·계획능력 × 교사정서지지 + 시간관리×공부부담→학업성취도 |
| 중등 정서조절취약형 | 0 | (기존 경로에 이미 포함) |
| 중등 자기주도몰입형 | 0 | (기존 경로에 이미 포함) |

---

## 3. 랭킹 알고리즘

### 3.1 입력

| 파라미터 | 타입 | 설명 |
|----------|------|------|
| tScores | number[38] | 학생의 38개 T점수 |
| predictedType | StudentType | LPA 유형명 |
| schoolLevel | SchoolLevel | '초등' \| '중등' |

### 3.2 처리 흐름

```
rankInterventions(tScores, predictedType, schoolLevel)
  │
  ├─ 1. 유형의 interventions 배열 조회 (lpaProfiles.ts)
  │
  ├─ 2. 각 intervention에 대해:
  │     ├─ x, z 필드에서 요인명 추출 → 38개 요인 인덱스 매칭
  │     ├─ needScore 계산 (절대적 필요도)
  │     ├─ deviationScore 계산 (유형 내 상대적 취약도)
  │     └─ betaBoost 계산 (통계적 효과크기)
  │
  ├─ 3. 가중합 → relevanceScore
  │
  └─ 4. 점수 내림차순 정렬 → RankedIntervention[] 반환
```

### 3.3 요인명 → 인덱스 매핑

intervention의 `x`, `z` 필드 값을 `getFactorByName()`으로 38개 요인 인덱스에 매칭한다.

- 단일 요인: `'자기효능감'` → index 1
- 복합 요인: `'수업태도/몰두/의미감'` → `'/'`로 분리 → [12, 20, 21]
- 38개 요인에 없는 값(예: `'협력학습'`): 무시 → 해당 경로는 기본 점수(0)

### 3.4 needScore (필요도 점수)

관련 요인의 T점수가 이상적 방향에서 얼마나 떨어져 있는지 측정한다.

```
정적 요인 (isPositive=true):  gap = max(0, 50 - tScore)
부적 요인 (isPositive=false): gap = max(0, tScore - 50)

needScore = mean(gaps) × (100 / 30)   // 0~100 정규화
```

**예시**: 자기효능감(정적) T=35 → gap = 50-35 = 15 → 높은 needScore

### 3.5 deviationScore (유형 편차 점수)

같은 유형의 평균(typeMeans) 대비 학생 개인이 얼마나 나쁜 방향으로 치우쳐 있는지 측정한다.

```
diff = tScore - typeMean

나쁜 방향 (정적 요인에서 평균보다 낮음 / 부적 요인에서 평균보다 높음):
  가중 편차 = |diff| × 1.5

나은 방향:
  가중 편차 = |diff| × 0.5

deviationScore = mean(가중 편차) × (100 / 15)   // 0~100 정규화
```

**예시**: 자원소진형의 자기효능감 평균 T=37.9인데, 학생이 T=32 → 나쁜 방향 편차 5.9 × 1.5 = 8.85

### 3.6 betaBoost (효과크기 점수)

경로의 통계적 효과크기(β)를 점수로 반영한다. β가 큰 경로일수록 개입 효과가 크므로 우선 추천.

```
betaBoost = min(100, |β| × 200)
```

| β 값 | betaBoost |
|:---:|:---:|
| 0.479 | 95.8 |
| 0.444 | 88.8 |
| 0.379 | 75.8 |
| 0.249 | 49.8 |
| 0.220 | 44.0 |
| 0.045 | 9.0 |
| 없음 (KG_INTERVENTION, INFERRED) | 0 |

### 3.7 최종 점수

**typeMeans가 있는 경우 (초등)**:
```
relevanceScore = needScore × 0.5 + deviationScore × 0.3 + betaBoost × 0.2
```

**typeMeans가 없는 경우 (중등, means=[])**:
```
relevanceScore = needScore × 0.65 + betaBoost × 0.35
```

| 가중치 | 의미 |
|--------|------|
| needScore 50~65% | 절대적 취약도 — T점수 자체가 낮은(또는 높은) 요인 우선 |
| deviationScore 0~30% | 상대적 취약도 — 같은 유형 내에서도 특히 약한 영역 반영 |
| betaBoost 20~35% | 효과크기 — 통계적으로 효과가 큰 경로 우선 반영 |

### 3.8 폴백 처리

| 상황 | 처리 |
|------|------|
| tScores가 없거나 길이 ≠ 38 | interventions 원래 순서 그대로, relevanceScore 100/90/80... |
| typeMeans가 빈 배열 (중등) | deviationScore = 0, needScore + betaBoost로 랭킹 |
| x, z에 38개 요인 외 값 | 해당 요인 무시, 매칭된 요인만으로 계산 |

---

## 4. 출력

### 4.1 RankedIntervention 인터페이스

```typescript
interface RankedIntervention {
  intervention: Intervention;      // 원본 경로 데이터
  relevanceScore: number;          // 0~100 (높을수록 관련도 높음)
  relevanceReason: string;         // 예: "자기효능감(T=35), 자아존중감(T=32) 보완 필요"
  involvedFactors: Array<{
    name: string;                  // 요인명
    score: number;                 // 학생 T점수
    typeMean: number | null;       // 유형 평균 (없으면 null)
  }>;
  scoreBreakdown?: {
    needScore: number;             // 필요도 점수 (0~100)
    deviationScore: number;        // 유형 편차 점수 (0~100)
    betaBoost: number;             // 효과크기 점수 (0~100)
  };
}
```

### 4.2 UI 표시

코칭 전략 모달(CoachingStrategy.tsx)에서:

- 경로가 relevanceScore 내림차순으로 정렬
- **상위 5개만 기본 표시** (`TOP_N = 5`): 유형별 경로가 많아짐에 따라 상위 5개 경로만 초기 노출
- **"더보기" 버튼**: 경로가 5개를 초과하면 하단에 `나머지 N개 경로 더보기` 버튼 표시
  - 클릭 시 전체 경로 펼침 + "상위 5개만 보기" 토글
  - 6번째부터는 "추가 추천 경로" 구분선으로 시각적 분리
- 각 경로 카드에 **관련도 배지** 표시 (50+ 빨간, 25+ 주황, 그 외 회색)
- **β 배지** 표시 — source=KG인 경로만 (β=0.479 등, indigo 색상)
- **⚠ 부정적 간접효과 경로**: β가 음수인 매개경로는 해석 문구에 `⚠ 주의:` 접두어 표시 (상세: §2.5)
- **출처 라벨** 표시:
  - `KG`: 라벨 없음 (β 배지가 신뢰도 표시 역할)
  - `KG_INTERVENTION`: `β 없음` (amber 배지) — KG에 근거하나 효과크기 미검증
  - `INFERRED`: `AI 추론` (purple 배지) — KG 근거 없음, 통계 검증 필요
- **인포 아이콘** (i): "추천 코칭 경로" 제목 옆, hover 시 3가지 출처에 대한 상세 설명 범례 표시
- 관련 요인의 **학생 T점수 + 유형 평균** 배지 표시
- 첫 번째 경로가 자동 선택됨
- 하단에 **다중 조절효과 주의사항** 표시

---

## 5. 예시

### 초등 자원소진형 학생 (T점수 예시)

| 요인 | 학생 T점수 | 유형 평균 | gap |
|------|:---:|:---:|:---:|
| 자기효능감 | 32 | 37.9 | 18 |
| 자아존중감 | 35 | 38.1 | 15 |
| 자기정서조절 | 45 | 42.9 | 5 |

**랭킹 결과** (needScore×0.5 + deviationScore×0.3 + betaBoost×0.2):

1. 경로 1 (자기효능감 → 자아존중감 → 성적만족도, β=0.220, `KG`): 관련도 **65** — 두 요인 취약 + β 반영
2. 경로 2 (자기효능감 × 자아존중감 → 학업성취도, β=0.173, `KG`): 관련도 **60** — 동일 요인, β 약간 낮음
3. 경로 3 (자기정서조절 → 정서안정, `KG_INTERVENTION`): 관련도 **18** — 정서조절 양호 + β 없음

→ 같은 자원소진형이라도 정서조절이 특히 낮은 학생은 경로 3이 상위로 올라옴

---

## 6. 전체 경로 목록

### 6.1 초등

#### 자원소진형 (8개: KG 7 + KG_INTERVENTION 1)

| # | 경로 | 효과유형 | source | β | 비고 |
|---|------|----------|--------|---|------|
| 1 | 자기효능감 × 자아존중감 → 학업성취도 | 긍정완충 | KG | 0.173 | |
| 2 | 자기효능감 → 자아존중감 → 성적만족도 | 완전매개 | KG | 0.220 | |
| 3 | 자기정서조절 → 정서안정 | 직접효과 | KG_INTERVENTION | — | |
| 4 | 수업부담 × 교사정서지지 → 학업성취도 | 촉진 | KG | 0.226 | +HF KG |
| 5 | 부모의사소통 × 교사정서지지 → 성적만족도 | 긍정완충 | KG | 0.188 | +HF KG |
| 6 | 조절능력 × 교사정서지지 → 성적만족도 | 긍정완충 | KG | 0.325 | +HF KG |
| 7 | 점검능력 × 교사정서지지 → 성적만족도 | 긍정완충 | KG | 0.341 | +HF KG |
| 8 | 계획능력 × 교사정서지지 → 성적만족도 | 긍정완충 | KG | 0.213 | +HF KG |

#### 안전균형형 (18개: KG 18)

| # | 경로 | 효과유형 | source | β | 비고 |
|---|------|----------|--------|---|------|
| 1 | 시간관리 × 계획능력 → 학업성취도 | 긍정강화 | KG | 0.157 | |
| 2 | 유능성 → 성장마인드셋 → 학업성취도 | 완전매개 | KG | 0.045 | |
| 3 | 점검능력 → 조절능력 → 학업성취도 | 완전매개 | KG | 0.117 | |
| 4 | 자기효능감 → 성장마인드셋 → 학업성취도 | 완전매개 | KG | 0.045 | +매개경로 |
| 5 | 자아존중감 → 성장마인드셋 → 학업성취도 | 완전매개 | KG | 0.045 | +매개경로 |
| 6 | 공부부담 → 성장마인드셋 → 학업성취도 | 완전매개 | KG | 0.045 | +매개경로 |
| 7 | 자기효능감 → 성장마인드셋 → 성적만족도 | 완전매개 | KG | 0.122 | +매개경로 |
| 8 | 자아존중감 → 성장마인드셋 → 성적만족도 | 완전매개 | KG | 0.122 | +매개경로 |
| 9 | 공부부담 → 성장마인드셋 → 성적만족도 | 완전매개 | KG | 0.122 | +매개경로 |
| 10 | 유능성 → 성장마인드셋 → 성적만족도 | 완전매개 | KG | 0.122 | +매개경로 |
| 11 | 친구공부비교 → 조절능력 → 학업성취도 | 완전매개 | KG | 0.117 | +매개경로 |
| 12 | 자기정서인식 → 의미감 → 성적만족도 | 완전매개 | KG | -0.033 | +매개경로 ⚠ |
| 13 | 수업부담 × 교사정서지지 → 학업성취도 | 촉진 | KG | 0.226 | +조절효과 |
| 14 | 부모의사소통 × 교사정서지지 → 성적만족도 | 긍정완충 | KG | 0.188 | +조절효과 |
| 15 | 조절능력 × 교사정서지지 → 성적만족도 | 긍정완충 | KG | 0.325 | +조절효과 |
| 16 | 점검능력 × 교사정서지지 → 성적만족도 | 긍정완충 | KG | 0.341 | +조절효과 |
| 17 | 계획능력 × 교사정서지지 → 성적만족도 | 긍정완충 | KG | 0.213 | +조절효과 |
| 18 | 시간관리 × 계획능력 → 성적만족도 | 긍정강화 | KG | 0.157 | +조절효과 |

#### 몰입자원풍부형 (3개: KG 1 + KG_INTERVENTION 1 + INFERRED 1)

| # | 경로 | 효과유형 | source | β | 비고 |
|---|------|----------|--------|---|------|
| 1 | 시험준비 → 학업성취도 | 직접효과 | INFERRED | — | |
| 2 | 유능성 → 성장마인드셋 → 학업성취도 | 완전매개 | KG | 0.079 | |
| 3 | 자아존중감 → 자기기준강화 | 직접효과 | KG_INTERVENTION | — | |

### 6.2 중등

#### 무기력형 (13개: KG 13)

| # | 경로 | 효과유형 | source | β | 비고 |
|---|------|----------|--------|---|------|
| 1 | 성장마인드셋 → 유능성 → 학업성취도 | 완전매개 | KG | 0.053 | |
| 2 | 수업부담 × 부모학업지지 → 학업성취도 | 촉진 | KG | 0.199 | |
| 3 | 시간관리 × 공부부담 → 성적만족도 | 촉진 | KG | 0.249 | |
| 4 | 수업부담 × 교사정서지지 → 학업성취도 | 촉진 | KG | 0.226 | |
| 5 | 부모공부부담 → 부모학업지지 → 성적만족도 | 완전매개 | KG | -0.077 | +매개경로 ⚠ |
| 6 | 부모공부부담 → 자기효능감 → 성적만족도 | 완전매개 | KG | -0.047 | +매개경로 ⚠ |
| 7 | 점검능력 → 조절능력 → 학업성취도 | 완전매개 | KG | 0.117 | +매개경로 |
| 8 | 친구공부비교 → 조절능력 → 학업성취도 | 완전매개 | KG | 0.117 | +매개경로 |
| 9 | 시간관리 × 공부부담 → 학업성취도 | 촉진 | KG | 0.249 | +조절효과 |
| 10 | 부모의사소통 × 교사정서지지 → 성적만족도 | 긍정완충 | KG | 0.188 | +조절효과 |
| 11 | 조절능력 × 교사정서지지 → 성적만족도 | 긍정완충 | KG | 0.325 | +조절효과 |
| 12 | 점검능력 × 교사정서지지 → 성적만족도 | 긍정완충 | KG | 0.341 | +조절효과 |
| 13 | 계획능력 × 교사정서지지 → 성적만족도 | 긍정완충 | KG | 0.213 | +조절효과 |

#### 정서조절취약형 (12개: KG 11 + INFERRED 1)

| # | 경로 | 효과유형 | source | β | 비고 |
|---|------|----------|--------|---|------|
| 1 | 수업태도/몰두/의미감 → 노트하기 → 학업성취도 | 완전매개 | KG | 0.092 | |
| 2 | 수업태도 × 자기정서인식 → 학업성취도 | 긍정완충 | KG | 0.320 | |
| 3 | 성장마인드셋 × 부모성적압력 → 성적만족도 | 촉진 | KG | 0.444 | |
| 4 | 수업태도 → 학업성취도 | 직접효과 | INFERRED | — | |
| 5 | 자기효능감 → 성장마인드셋 → 학업성취도 | 완전매개 | KG | 0.045 | +매개경로 |
| 6 | 자아존중감 → 성장마인드셋 → 학업성취도 | 완전매개 | KG | 0.045 | +매개경로 |
| 7 | 공부부담 → 성장마인드셋 → 학업성취도 | 완전매개 | KG | 0.045 | +매개경로 |
| 8 | 유능성 → 성장마인드셋 → 학업성취도 | 완전매개 | KG | 0.045 | +매개경로 |
| 9 | 자기효능감 → 성장마인드셋 → 성적만족도 | 완전매개 | KG | 0.122 | +매개경로 |
| 10 | 자아존중감 → 성장마인드셋 → 성적만족도 | 완전매개 | KG | 0.122 | +매개경로 |
| 11 | 공부부담 → 성장마인드셋 → 성적만족도 | 완전매개 | KG | 0.122 | +매개경로 |
| 12 | 유능성 → 성장마인드셋 → 성적만족도 | 완전매개 | KG | 0.122 | +매개경로 |

#### 자기주도몰입형 (3개: KG 2 + KG_INTERVENTION 1)

| # | 경로 | 효과유형 | source | β | 비고 |
|---|------|----------|--------|---|------|
| 1 | 타인정서인식 × 활기 → 성적만족도 | 긍정강화 | KG | 0.479 | |
| 2 | 관계성 × 타인공감능력 → 학업성취도 | 긍정강화 | KG | 0.379 | |
| 3 | 타인공감능력 → 협력학습 | 직접효과 | KG_INTERVENTION | — | |

---

**Last Updated**: 2026-02-22
