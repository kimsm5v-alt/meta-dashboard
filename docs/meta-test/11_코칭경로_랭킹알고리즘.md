# 개인별 코칭 경로 랭킹 알고리즘

## 1. 개요

### 1.1 목적
같은 LPA 유형이라도 학생마다 38개 T점수 프로필이 다르므로, 유형별 코칭 경로를 개인의 취약 요인에 따라 관련도 순으로 정렬하여 맞춤형 코칭을 지원한다.

### 1.2 위치
- 알고리즘: `src/shared/utils/interventionRanker.ts`
- 코칭 경로 데이터: `src/shared/data/lpaProfiles.ts` → `TypeProfile.interventions`
- 지식그래프: `src/shared/data/knowledgeGraph.ts`
- UI: `src/features/student-dashboard/components/CoachingStrategy.tsx`

---

## 2. 코칭 경로 데이터 구조

### 2.1 Intervention 인터페이스

```typescript
interface Intervention {
  x: string;           // 독립변수 (예: '자기효능감')
  z: string | null;    // 매개/조절변수 (예: '자아존중감', 없으면 null)
  y: string;           // 결과변수 (예: '학업성취도')
  effectType: EffectType;  // 효과 유형
  interpretation: string;  // 경로 해석
  strategies: string[];    // 구체적 실행 전략 (3개)
  beta?: number;           // 효과크기 (|β|, 양수) — KG 통계 검증 경로만
  source?: 'KG' | 'KG_INTERVENTION' | 'INFERRED';  // 데이터 출처
}
```

### 2.2 데이터 출처 (source)

| source | 의미 | β 유무 | UI 배지 | 설명 |
|--------|------|:---:|------|------|
| `KG` | 매개경로 또는 조절효과 (통계적 검증) | O | `β=0.XXX` (indigo) | 지식그래프의 매개경로 또는 조절효과에서 도출. 통계적으로 검증된 효과크기(β)가 있어 신뢰도가 가장 높음 |
| `KG_INTERVENTION` | 지식그래프 개입전략 노드 | X | `β 없음` (amber) | 지식그래프에 개입전략 노드가 존재하나, 매개/조절 분석이 수행되지 않아 β 계수가 없음. 경로의 방향성은 KG에 근거하지만 효과크기는 미검증 |
| `INFERRED` | AI 추론 (KG 근거 없음) | X | `AI 추론` (purple) | 지식그래프에 직접적 근거가 없으며, 유형 특성과 요인 프로필을 바탕으로 AI가 생성한 경로. 추후 통계 검증 필요 |

### 2.3 효과 유형 (EffectType)

| 유형 | 의미 | 예시 |
|------|------|------|
| 직접효과 | X가 Y에 직접 영향 (z=null) | 시험준비 → 학업성취도 |
| 완전매개 | X → Z → Y 매개 경로 | 자기효능감 → 자아존중감 → 성적만족도 |
| 긍정강화 | X × Z 결합 시 시너지 | 타인정서인식 × 활기 → 성적만족도 |
| 긍정완충 | X × Z 동시 강화 시 효과 감소 | 효능감 × 자존감 동시 상승 → 심리 부하 |
| 촉진 | Z 수준에 따라 X 효과 증폭 | 시간관리 × 공부부담 → 성적만족도 |

### 2.4 유형별 경로 수 및 검증 상태

| 학교급 | 유형 | 경로 수 | KG | KG_INTERVENTION | INFERRED | 상세 |
|--------|------|:---:|:---:|:---:|:---:|------|
| 초등 | 자원소진형 | 3 | 2 | 1 | 0 | 조절효과(β=0.173) + 매개경로(β=0.220) + 개입전략(자기정서조절→정서안정) |
| 초등 | 안전균형형 | 3 | 3 | 0 | 0 | 조절효과(β=0.157) + 매개경로(β=0.045) + 매개경로(β=0.117) |
| 초등 | 몰입자원풍부형 | 3 | 1 | 1 | 1 | 추론(시험준비→학업성취도) + 매개경로(β=0.079) + 개입전략(자아존중감→자기기준강화) |
| 중등 | 무기력형 | 4 | 4 | 0 | 0 | 매개(β=0.053) + 조절(β=0.199) + 조절(β=0.249) + 조절(β=0.226) |
| 중등 | 정서조절취약형 | 4 | 3 | 0 | 1 | 매개(β=0.092) + 조절(β=0.320) + 조절(β=0.444) + 추론(수업태도→학업성취도) |
| 중등 | 자기주도몰입형 | 3 | 2 | 1 | 0 | 조절(β=0.479) + 조절(β=0.379) + 개입전략(타인공감능력→협력학습) |
| | **합계** | **20** | **15** | **3** | **2** | |

**β 커버리지: 15/20 (75%)**

경로 데이터는 로컬 지식그래프 + HuggingFace KG 데이터에서 파생되었다.

---

## 3. 랭킹 알고리즘

### 3.1 입력

| 파라미터 | 타입 | 설명 |
|----------|------|------|
| tScores | number[38] | 학생의 38개 T점수 |
| predictedType | StudentType | LPA 유형명 |
| schoolLevel | SchoolLevel | '초등' \| '중등' |

### 3.2 처리 흐름

```
rankInterventions(tScores, predictedType, schoolLevel)
  │
  ├─ 1. 유형의 interventions 배열 조회 (lpaProfiles.ts)
  │
  ├─ 2. 각 intervention에 대해:
  │     ├─ x, z 필드에서 요인명 추출 → 38개 요인 인덱스 매칭
  │     ├─ needScore 계산 (절대적 필요도)
  │     ├─ deviationScore 계산 (유형 내 상대적 취약도)
  │     └─ betaBoost 계산 (통계적 효과크기)
  │
  ├─ 3. 가중합 → relevanceScore
  │
  └─ 4. 점수 내림차순 정렬 → RankedIntervention[] 반환
```

### 3.3 요인명 → 인덱스 매핑

intervention의 `x`, `z` 필드 값을 `getFactorByName()`으로 38개 요인 인덱스에 매칭한다.

- 단일 요인: `'자기효능감'` → index 1
- 복합 요인: `'수업태도/몰두/의미감'` → `'/'`로 분리 → [12, 20, 21]
- 38개 요인에 없는 값(예: `'협력학습'`): 무시 → 해당 경로는 기본 점수(0)

### 3.4 needScore (필요도 점수)

관련 요인의 T점수가 이상적 방향에서 얼마나 떨어져 있는지 측정한다.

```
정적 요인 (isPositive=true):  gap = max(0, 50 - tScore)
부적 요인 (isPositive=false): gap = max(0, tScore - 50)

needScore = mean(gaps) × (100 / 30)   // 0~100 정규화
```

**예시**: 자기효능감(정적) T=35 → gap = 50-35 = 15 → 높은 needScore

### 3.5 deviationScore (유형 편차 점수)

같은 유형의 평균(typeMeans) 대비 학생 개인이 얼마나 나쁜 방향으로 치우쳐 있는지 측정한다.

```
diff = tScore - typeMean

나쁜 방향 (정적 요인에서 평균보다 낮음 / 부적 요인에서 평균보다 높음):
  가중 편차 = |diff| × 1.5

나은 방향:
  가중 편차 = |diff| × 0.5

deviationScore = mean(가중 편차) × (100 / 15)   // 0~100 정규화
```

**예시**: 자원소진형의 자기효능감 평균 T=37.9인데, 학생이 T=32 → 나쁜 방향 편차 5.9 × 1.5 = 8.85

### 3.6 betaBoost (효과크기 점수)

경로의 통계적 효과크기(β)를 점수로 반영한다. β가 큰 경로일수록 개입 효과가 크므로 우선 추천.

```
betaBoost = min(100, |β| × 200)
```

| β 값 | betaBoost |
|:---:|:---:|
| 0.479 | 95.8 |
| 0.444 | 88.8 |
| 0.379 | 75.8 |
| 0.249 | 49.8 |
| 0.220 | 44.0 |
| 0.045 | 9.0 |
| 없음 (KG_INTERVENTION, INFERRED) | 0 |

### 3.7 최종 점수

**typeMeans가 있는 경우 (초등)**:
```
relevanceScore = needScore × 0.5 + deviationScore × 0.3 + betaBoost × 0.2
```

**typeMeans가 없는 경우 (중등, means=[])**:
```
relevanceScore = needScore × 0.65 + betaBoost × 0.35
```

| 가중치 | 의미 |
|--------|------|
| needScore 50~65% | 절대적 취약도 — T점수 자체가 낮은(또는 높은) 요인 우선 |
| deviationScore 0~30% | 상대적 취약도 — 같은 유형 내에서도 특히 약한 영역 반영 |
| betaBoost 20~35% | 효과크기 — 통계적으로 효과가 큰 경로 우선 반영 |

### 3.8 폴백 처리

| 상황 | 처리 |
|------|------|
| tScores가 없거나 길이 ≠ 38 | interventions 원래 순서 그대로, relevanceScore 100/90/80... |
| typeMeans가 빈 배열 (중등) | deviationScore = 0, needScore + betaBoost로 랭킹 |
| x, z에 38개 요인 외 값 | 해당 요인 무시, 매칭된 요인만으로 계산 |

---

## 4. 출력

### 4.1 RankedIntervention 인터페이스

```typescript
interface RankedIntervention {
  intervention: Intervention;      // 원본 경로 데이터
  relevanceScore: number;          // 0~100 (높을수록 관련도 높음)
  relevanceReason: string;         // 예: "자기효능감(T=35), 자아존중감(T=32) 보완 필요"
  involvedFactors: Array<{
    name: string;                  // 요인명
    score: number;                 // 학생 T점수
    typeMean: number | null;       // 유형 평균 (없으면 null)
  }>;
  scoreBreakdown?: {
    needScore: number;             // 필요도 점수 (0~100)
    deviationScore: number;        // 유형 편차 점수 (0~100)
    betaBoost: number;             // 효과크기 점수 (0~100)
  };
}
```

### 4.2 UI 표시

코칭 전략 모달(CoachingStrategy.tsx)에서:

- 경로가 relevanceScore 내림차순으로 정렬
- 각 경로 카드에 **관련도 배지** 표시 (50+ 빨간, 25+ 주황, 그 외 회색)
- **β 배지** 표시 — source=KG인 경로만 (β=0.479 등, indigo 색상)
- **출처 라벨** 표시:
  - `KG`: 라벨 없음 (β 배지가 신뢰도 표시 역할)
  - `KG_INTERVENTION`: `β 없음` (amber 배지) — KG에 근거하나 효과크기 미검증
  - `INFERRED`: `AI 추론` (purple 배지) — KG 근거 없음, 통계 검증 필요
- **인포 아이콘** (i): "추천 코칭 경로" 제목 옆, hover 시 3가지 출처에 대한 상세 설명 범례 표시
- 관련 요인의 **학생 T점수 + 유형 평균** 배지 표시
- 첫 번째 경로가 자동 선택됨
- 하단에 **다중 조절효과 주의사항** 표시

---

## 5. 예시

### 초등 자원소진형 학생 (T점수 예시)

| 요인 | 학생 T점수 | 유형 평균 | gap |
|------|:---:|:---:|:---:|
| 자기효능감 | 32 | 37.9 | 18 |
| 자아존중감 | 35 | 38.1 | 15 |
| 자기정서조절 | 45 | 42.9 | 5 |

**랭킹 결과** (needScore×0.5 + deviationScore×0.3 + betaBoost×0.2):

1. 경로 1 (자기효능감 → 자아존중감 → 성적만족도, β=0.220, `KG`): 관련도 **65** — 두 요인 취약 + β 반영
2. 경로 2 (자기효능감 × 자아존중감 → 학업성취도, β=0.173, `KG`): 관련도 **60** — 동일 요인, β 약간 낮음
3. 경로 3 (자기정서조절 → 정서안정, `KG_INTERVENTION`): 관련도 **18** — 정서조절 양호 + β 없음

→ 같은 자원소진형이라도 정서조절이 특히 낮은 학생은 경로 3이 상위로 올라옴

---

## 6. 전체 경로 목록

### 6.1 초등

#### 자원소진형 (3개: KG 2 + KG_INTERVENTION 1)

| # | 경로 | 효과유형 | source | β |
|---|------|----------|--------|---|
| 1 | 자기효능감 × 자아존중감 → 학업성취도 | 긍정완충 | KG | 0.173 |
| 2 | 자기효능감 → 자아존중감 → 성적만족도 | 완전매개 | KG | 0.220 |
| 3 | 자기정서조절 → 정서안정 | 직접효과 | KG_INTERVENTION | — |

#### 안전균형형 (3개: KG 3)

| # | 경로 | 효과유형 | source | β |
|---|------|----------|--------|---|
| 1 | 시간관리 × 계획능력 → 학업성취도 | 촉진 | KG | 0.157 |
| 2 | 유능성 → 성장마인드셋 → 학업성취도 | 완전매개 | KG | 0.045 |
| 3 | 점검능력 → 조절능력 → 학업성취도 | 완전매개 | KG | 0.117 |

#### 몰입자원풍부형 (3개: KG 1 + KG_INTERVENTION 1 + INFERRED 1)

| # | 경로 | 효과유형 | source | β |
|---|------|----------|--------|---|
| 1 | 시험준비 → 학업성취도 | 직접효과 | INFERRED | — |
| 2 | 유능성 → 성장마인드셋 → 학업성취도 | 완전매개 | KG | 0.079 |
| 3 | 자아존중감 → 자기기준강화 | 직접효과 | KG_INTERVENTION | — |

### 6.2 중등

#### 무기력형 (4개: KG 4)

| # | 경로 | 효과유형 | source | β |
|---|------|----------|--------|---|
| 1 | 성장마인드셋 → 유능성 → 학업성취도 | 완전매개 | KG | 0.053 |
| 2 | 수업부담 × 부모학업지지 → 학업성취도 | 촉진 | KG | 0.199 |
| 3 | 시간관리 × 공부부담 → 성적만족도 | 촉진 | KG | 0.249 |
| 4 | 수업부담 × 교사정서지지 → 학업성취도 | 촉진 | KG | 0.226 |

#### 정서조절취약형 (4개: KG 3 + INFERRED 1)

| # | 경로 | 효과유형 | source | β |
|---|------|----------|--------|---|
| 1 | 수업태도/몰두/의미감 → 노트하기 → 학업성취도 | 완전매개 | KG | 0.092 |
| 2 | 수업태도 × 자기정서인식 → 학업성취도 | 긍정강화 | KG | 0.320 |
| 3 | 성장마인드셋 × 부모성적압력 → 성적만족도 | 촉진 | KG | 0.444 |
| 4 | 수업태도 → 학업성취도 | 직접효과 | INFERRED | — |

#### 자기주도몰입형 (3개: KG 2 + KG_INTERVENTION 1)

| # | 경로 | 효과유형 | source | β |
|---|------|----------|--------|---|
| 1 | 타인정서인식 × 활기 → 성적만족도 | 긍정강화 | KG | 0.479 |
| 2 | 관계성 × 타인공감능력 → 학업성취도 | 긍정강화 | KG | 0.379 |
| 3 | 타인공감능력 → 협력학습 | 직접효과 | KG_INTERVENTION | — |

---

**Last Updated**: 2026-02-22
